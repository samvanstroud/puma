# Histograms

To set up the inputs for the plots, have a look [here](./index.md).

The following examples use the dummy data which is described [here](./dummy_data.md)

## _b_-tagging discriminant plot

<img src=https://github.com/umami-hep/puma/raw/examples-material/histogram_discriminant.png width=500>

```py
"""Produce histogram of discriminant from tagger output and labels."""

import numpy as np

from puma import Histogram, HistogramPlot
from puma.utils import get_dummy_2_taggers, get_good_linestyles, global_config

# The line below generates dummy data which is similar to a NN output
df = get_dummy_2_taggers()

# Calculate discriminant scores for DIPS and RNNIP, and add them to the dataframe
FRAC_C = 0.018
df["disc_dips"] = np.log(
    df["dips_pb"] / (FRAC_C * df["dips_pc"] + (1 - FRAC_C) * df["dips_pu"])
)
df["disc_rnnip"] = np.log(
    df["rnnip_pb"] / (FRAC_C * df["rnnip_pc"] + (1 - FRAC_C) * df["rnnip_pu"])
)

# defining boolean arrays to select the different flavour classes
is_light = df["HadronConeExclTruthLabelID"] == 0
is_c = df["HadronConeExclTruthLabelID"] == 4
is_b = df["HadronConeExclTruthLabelID"] == 5

flav_cat = global_config["flavour_categories"]
taggers = ["dips", "rnnip"]
linestyles = get_good_linestyles()[:2]

# Initialise histogram plot
plot_histo = HistogramPlot(
    n_ratio_panels=1,
    ylabel="Normalised number of jets",
    ylabel_ratio_1="Ratio to DIPS",
    xlabel="$b$-jet discriminant",
    logy=False,
    leg_ncol=1,
    figsize=(5.5, 4.5),
    bins=np.linspace(-10, 10, 50),
    y_scale=1.5,
    ymax_ratio_1=1.5,
    ymin_ratio_1=0.5,
    atlas_second_tag="$\\sqrt{s}=13$ TeV, dummy jets \ndummy sample, $f_{c}=0.018$",
)

# Add the histograms
for tagger, linestyle in zip(taggers, linestyles):

    plot_histo.add(
        Histogram(
            df[is_light][f"disc_{tagger}"],
            # Only specify the label for the case of the "DIPS" light-jets, since we
            # want to hide the legend entry for "RNNIP" light-jets as it has the same
            # linecolour. Instead, we specify a "linestyle legend" further down in the
            # script
            label="Light-flavour jets" if tagger == "dips" else None,
            colour=flav_cat["ujets"]["colour"],
            ratio_group="ujets",
            linestyle=linestyle,
        ),
        reference=tagger == "dips",
    )
    plot_histo.add(
        Histogram(
            df[is_c][f"disc_{tagger}"],
            label="$c$-jets" if tagger == "dips" else None,
            colour=flav_cat["cjets"]["colour"],
            ratio_group="cjets",
            linestyle=linestyle,
        ),
        reference=tagger == "dips",
    )
    plot_histo.add(
        Histogram(
            df[is_b][f"disc_{tagger}"],
            label="$b$-jets" if tagger == "dips" else None,
            colour=flav_cat["bjets"]["colour"],
            ratio_group="bjets",
            linestyle=linestyle,
        ),
        reference=tagger == "dips",
    )

plot_histo.draw()
# The lines below create a legend for the linestyles (i.e. solid lines -> DIPS, dashed
# lines -> RNNIP here). The "bbox_to_anchor" argument specifies where to place the
# linestyle legend
plot_histo.make_linestyle_legend(
    linestyles=linestyles, labels=["DIPS", "RNNIP"], bbox_to_anchor=(0.55, 1)
)
plot_histo.savefig("histogram_discriminant.png", transparent=False)
```

## Flavour probabilities plot

<img src=https://github.com/umami-hep/puma/raw/examples-material/histogram_bjets_probability.png width=500>

```py
"""Example plot script for flavour probability comparison."""

from puma import Histogram, HistogramPlot
from puma.utils import get_dummy_2_taggers

# The line below generates dummy data which is similar to a NN output
df = get_dummy_2_taggers()

# Initialise histogram plot
plot_histo = HistogramPlot(
    n_ratio_panels=0,
    ylabel="Normalised number of jets",
    xlabel="$b$-jets probability",
    logy=True,
    leg_ncol=1,
    atlas_first_tag="Simulation, $\\sqrt{s}=13$ TeV",
    atlas_second_tag="dummy sample, dummy jets",
    atlas_brand=None,  # You can deactivate the ATLAS branding (e.g. for a thesis)
    draw_errors=False,
    # bins=np.linspace(0, 1, 30),  # you can also force a binning for the plot here
)

# Add the ttbar histograms
u_jets = df.query("HadronConeExclTruthLabelID==0")
c_jets = df.query("HadronConeExclTruthLabelID==4")
b_jets = df.query("HadronConeExclTruthLabelID==5")

# the "flavour" argument will add a "light-flavour jets" (or other) prefix to the label
# + set the colour to the one that is defined in puma.utils.global_config
plot_histo.add(Histogram(u_jets["dips_pb"], flavour="ujets", linestyle="dashed"))
plot_histo.add(Histogram(c_jets["dips_pb"], flavour="cjets", linestyle="dashdot"))
plot_histo.add(Histogram(b_jets["dips_pb"], flavour="bjets"))

plot_histo.draw()
plot_histo.savefig("histogram_bjets_probability.png", transparent=False)
```

## More general example

In most cases you probably want to plot histograms with the different flavours
like in the examples above.
However, the `puma` API allows to plot any kind of data. As an example, you
could also produce a `MC` vs `data` plot with the following example code:

<img src=https://github.com/umami-hep/puma/raw/examples-material/histogram_basic_example.png width=500>

```py
"""Example of histogram plot that deviates from puma default plots."""

import numpy as np

from puma import Histogram, HistogramPlot

# Generate two distributions to plot
N_BKG = int(1e6)
N_SIG = int(2e4)
rng = np.random.default_rng(seed=42)
expectation = rng.exponential(size=N_BKG)
measurement = np.concatenate(
    (rng.exponential(size=N_BKG), rng.normal(loc=2, scale=0.2, size=N_SIG))
)
expectation_hist = Histogram(expectation, label="MC", histtype="stepfilled", alpha=1)
measurement_hist = Histogram(measurement, label="dummy data")

# Initialise histogram plot
plot_histo = HistogramPlot(
    ylabel="Number of events",
    xlabel="Invariant mass $m$ [a.u.]",
    logy=False,
    # bins=np.linspace(0, 5, 60),  # you can force a binning for the plot here
    bins=50,  # you can also define an integer number for the number of bins
    bins_range=(1.1, 4),  # only considered if bins is an integer
    norm=False,
    atlas_first_tag="Simulation Internal",
    atlas_second_tag="Example for more general plot",
    figsize=(6, 5),
    n_ratio_panels=1,
)

# Add histograms and plot
plot_histo.add(expectation_hist, reference=True)
plot_histo.add(measurement_hist)
plot_histo.draw()

plot_histo.savefig("histogram_basic_example.png", transparent=False)
```

## Weighted histograms

`puma` also supports weighted histograms by specifying the optional argument `weights`.
An example is given below:

<img src=https://github.com/umami-hep/puma/raw/examples-material/histogram_weighted.png width=500>

```py
"""Example script for plotting weighted histograms"""
import numpy as np

from puma import Histogram, HistogramPlot

rng = np.random.default_rng(seed=42)
# we define two gaussian distributions - one located at 0, one at 3
values = np.hstack((rng.normal(size=10_000), rng.normal(loc=3, size=10_000)))
# for the weighted histogram we weight entries of the right peak by a factor of 2
weights = np.hstack((np.ones(10_000), 2 * np.ones(10_000)))

hist_plot = HistogramPlot(n_ratio_panels=1, norm=False)
# add the unweighted histogram
hist_plot.add(
    Histogram(values, label="Without weights"),
    reference=True,
)
# add the weighted histogram
hist_plot.add(
    Histogram(
        values,
        weights=weights,
        label="Weight 2 for right peak",
    )
)
hist_plot.draw()
hist_plot.savefig("histogram_weighted.png")
```
